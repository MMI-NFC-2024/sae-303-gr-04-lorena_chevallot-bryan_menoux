---
import * as d3 from "d3";
import fs from "fs";
import path from "path";
const assetsDir = path.join(process.cwd(), "src", "assets");
const entreesMuseeText = fs.readFileSync(
  path.join(assetsDir, "ENTREES_ET_CATEGORIES_DE_PUBLIC@2.csv"),
  "utf8"
);
const entreesMusee2021 = d3.csvParse(entreesMuseeText);
const indicePauvreteText = fs.readFileSync(
  path.join(assetsDir, "indice-pauvrete-21@1.csv"),
  "utf8"
);
const indicePauvrete2021 = d3.csvParse(indicePauvreteText);
const populationText = fs.readFileSync(
  path.join(assetsDir, "detail_population@2.json"),
  "utf8"
);
const population = JSON.parse(populationText);
const normalize = (s: any) =>
  s
    ?.toString()
    .trim()
    .toLowerCase()
    .normalize("NFD")
    .replace(/[\u0300-\u036f]/g, "")
    .replace(/'/g, "'")
    .replace(/\s+/g, " ");

const normalizeCode = (code: any) =>
  String(code).trim().replace(".0", "").padStart(2, "0");
const populationTotale = population.filter(
  (d: any) =>
    d["Niveau Géo"] === "Département" &&
    d["Âge"]?.trim() === "Total" &&
    d["Sexe"]?.trim() === "Total" &&
    d["Mesure du recensement "] === "Population" &&
    d["Période"] === 2010
);
const popParDep = d3
  .rollups(
    populationTotale,
    (v: any) => d3.sum(v, (d: any) => +d["Valeur"]),
    (d: any) => normalize(d["Géographie"])
  )
  .map(([departement, population]: any) => ({ departement, population }));
const museeParDep = d3
  .rollups(
    entreesMusee2021,
    (v: any) => d3.sum(v, (d: any) => +(d as any).total || 0),
    (d: any) => normalize((d as any).departement)
  )
  .map(([departement, total_musees]: any) => ({ departement, total_musees }));
const pauvreteParDep = indicePauvrete2021.map((d: any) => ({
  departement: normalize(d.departement),
  taux_pauvrete: +d.taux_pauvrete,
}));
const merged = museeParDep
  .map((m: any) => {
    const p = pauvreteParDep.find((x: any) => x.departement === m.departement);
    const pop = popParDep.find((x: any) => x.departement === m.departement);
    return {
      departement: m.departement,
      total_musees: m.total_musees,
      population: pop ? pop.population : null,
      taux_pauvrete: p ? p.taux_pauvrete : null,
    };
  })
  .filter((d: any) => d.population && d.taux_pauvrete && d.total_musees > 0);
const data = merged.map((d: any) => ({
  departement: d.departement,
  taux_pauvrete: d.taux_pauvrete,
  entrees_par_habitant: (d.total_musees / d.population) * 10000,
}));
const dataJson = JSON.stringify(data);

const uniqueId = `graph-4-${Math.random().toString(36).substr(2, 9)}`;
---

<div class="graph-container" data-graph-id={uniqueId}>
  <div class="plot-holder flex justify-center min-h-[550px] items-center">
    <div class="text-zinc-400">Chargement du graphique...</div>
  </div>
  <div class="tooltip"></div>
</div>
<script type="module" define:vars={{ dataJson, uniqueId }}>
  (async () => {
    const Plot = await import(
      "https://cdn.jsdelivr.net/npm/@observablehq/plot@0.6/+esm"
    );
    const data = JSON.parse(dataJson);

    const container = document.querySelector(`[data-graph-id="${uniqueId}"]`);
    const plotHolder = container?.querySelector(".plot-holder");
    const tooltip = container?.querySelector(".tooltip");

    try {
      const plot = Plot.plot({
        x: { label: "Taux de pauvreté (%)", grid: true },
        y: {
          label: "Entrées aux musées pour 10 000 habitants",
          grid: true,
        },
        marks: [
          Plot.dot(data, {
            x: "taux_pauvrete",
            y: "entrees_par_habitant",
            fill: "#0868ac",
            r: 5,
            title: (d) =>
              `${d.departement}\n${d.taux_pauvrete}% de pauvreté\n${d.entrees_par_habitant.toFixed(
                1
              )} entrées / 10 000 hab.`,
            ariaLabel: null,
          }),
          Plot.linearRegressionY(data, {
            x: "taux_pauvrete",
            y: "entrees_par_habitant",
            stroke: "red",
            strokeWidth: 2,
          }),
        ],
        width: 800,
        height: 550,
        marginLeft: 80,
      });

      if (plotHolder && tooltip) {
        plotHolder.innerHTML = "";
        plotHolder.appendChild(plot);

        const dots = plotHolder.querySelectorAll("circle");

        const dotTitles = new Map();
        dots.forEach((dot) => {
          const titleElement = dot.querySelector("title");
          const title = titleElement?.textContent || "";
          dotTitles.set(dot, title);

          if (titleElement) {
            titleElement.remove();
          }
          dot.removeAttribute("aria-label");
        });

        dots.forEach((dot) => {
          dot.style.cursor = "pointer";
          dot.style.transition = "all 0.2s ease";

          dot.addEventListener("mouseenter", (e) => {
            const title = dotTitles.get(dot);

            tooltip.textContent = title;
            tooltip.style.display = "block";
            tooltip.style.left = e.clientX + 10 + "px";
            tooltip.style.top = e.clientY + 10 + "px";

            dot.style.r = "8";
            dot.style.strokeWidth = "2";
            dot.style.filter = "brightness(1.2)";
          });

          dot.addEventListener("mousemove", (e) => {
            tooltip.style.left = e.clientX + 10 + "px";
            tooltip.style.top = e.clientY + 10 + "px";
          });

          dot.addEventListener("mouseleave", () => {
            tooltip.style.display = "none";
            dot.style.r = "5";
            dot.style.strokeWidth = "1";
            dot.style.filter = "none";
          });
        });
      }
    } catch (err) {
      console.error("Erreur:", err);
      plotHolder.innerHTML =
        '<div class="text-red-400">Erreur de chargement du graphique</div>';
    }
  })();
</script>
<style>
  .graph-container {
    position: relative;
    width: 100%;
    display: flex;
    justify-content: center;
    align-items: center;
    padding: 1rem;
  }

  .graph-container :global(svg text) {
    font-size: 15px !important;
  }

  .tooltip {
    position: fixed;
    display: none;
    background: rgba(0, 0, 0, 0.95);
    color: white;
    padding: 10px 14px;
    border-radius: 6px;
    font-size: 15px;
    font-weight: 600;
    font-family:
      system-ui,
      -apple-system,
      sans-serif;
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.4);
    pointer-events: none;
    white-space: pre-line;
    line-height: 1.6;
    border: 1px solid rgba(255, 255, 255, 0.2);
    z-index: 1000;
  }
</style>
